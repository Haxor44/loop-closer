"use client";

import Sidebar from "@/components/Dashboard/Sidebar";
import { useSession, signIn } from "next-auth/react";
import { useEffect, useState, Suspense } from "react";
import { useSearchParams } from "next/navigation";

interface IntegrationStatus {
    reddit: boolean;
    tiktok: boolean;
    twitter: boolean;
    instagram: boolean;
    facebook: boolean;
    jira: boolean;
}

function SettingsContent() {
    const { data: session } = useSession();
    const [plan, setPlan] = useState("Free");
    const searchParams = useSearchParams();
    const [integrations, setIntegrations] = useState<IntegrationStatus>({
        reddit: false,
        tiktok: false,
        twitter: false,
        instagram: false,
        facebook: false,
        jira: false,
    });
    const [notification, setNotification] = useState<{ type: string; message: string } | null>(null);

    const [config, setConfig] = useState({
        keywords: "",
        subreddits: "",
        twitter_keywords: ""
    });

    useEffect(() => {
        if (session?.user?.email) {
            // 1. Sync User with Backend & Get Config
            const apiUrl = "http://localhost:8001/api/users/sync";
            console.log("Syncing user to:", apiUrl);
            console.log("VERSION_CHECK: v4_FIXED_URLS");

            fetch(apiUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Cache-Control": "no-cache"
                },
                body: JSON.stringify({ email: session.user.email, name: session.user.name }),
                cache: "no-store"
            })
                .then(res => res.json())
                .then(data => {
                    if (data.user) {
                        setPlan(data.user.plan);
                        if (data.user.name) {
                            console.log("Setting name from DB:", data.user.name);
                            setName(data.user.name); // Always trust DB over session
                        }
                        if (data.user.config) {
                            setConfig({
                                keywords: data.user.config.keywords || "",
                                subreddits: data.user.config.subreddits || "",
                                twitter_keywords: data.user.config.twitter_keywords || ""
                            });
                        }
                        // Restore connected platforms
                        if (data.user.connected_platforms) {
                            const newIntegrations = { ...integrations };
                            data.user.connected_platforms.forEach((p: string) => {
                                if (p in newIntegrations) {
                                    newIntegrations[p as keyof IntegrationStatus] = true;
                                }
                            });
                            setIntegrations(newIntegrations);
                        }
                    }
                });
        }
    }, [session]);

    // Handle form changes
    const handleConfigChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, value } = e.target;
        setConfig(prev => ({ ...prev, [name]: value }));
    };

    const [name, setName] = useState("");

    useEffect(() => {
        // Only set name from session if we haven't fetched it yet
        if (session?.user?.name && !name) setName(session.user.name);
    }, [session]);

    // ... (inside useEffect for backend sync, update name if needed)

    // ...

    const handleUpdateProfile = async () => {
        if (!session?.user?.email) return;

        try {
            const res = await fetch(`http://localhost:8001/api/users/profile`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    email: session.user.email,
                    name: name // Use state name
                })
            });

            if (res.ok) {
                setNotification({ type: "success", message: "Profile updated successfully!" });
                setTimeout(() => setNotification(null), 3000);
            } else {
                setNotification({ type: "error", message: "Failed to update profile" });
            }
        } catch (error) {
            setNotification({ type: "error", message: "Error updating profile" });
        }
    };

    const [isSavingConfig, setIsSavingConfig] = useState(false);

    const handleSaveConfig = async () => {
        if (!session?.user?.email) return;
        setIsSavingConfig(true);

        try {
            // Hardcode URL to match other fixes
            const res = await fetch(`http://localhost:8001/api/users/config`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    email: session.user.email,
                    ...config
                })
            });

            if (res.ok) {
                setNotification({ type: "success", message: "Configuration saved successfully!" });
                setTimeout(() => setNotification(null), 3000);
            } else {
                const data = await res.json();
                setNotification({ type: "error", message: data.detail || "Failed to save configuration" });
            }
        } catch (error) {
            setNotification({ type: "error", message: "Error saving configuration" });
        } finally {
            setIsSavingConfig(false);
        }
    };

    const updateIntegrationStatus = async (platform: string, connected: boolean) => {
        if (!session?.user?.email) return;
        try {
            await fetch(`http://localhost:8001/api/users/integrations`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    email: session.user.email,
                    platform,
                    connected
                })
            });
        } catch (error) {
            console.error("Failed to persist integration status", error);
        }
    };

    // Handle OAuth callback notifications
    useEffect(() => {
        const integration = searchParams.get("integration");
        const status = searchParams.get("status");
        const payment = searchParams.get("payment");

        if (integration && status) {
            if (status === "success") {
                setIntegrations(prev => ({ ...prev, [integration]: true }));
                setNotification({ type: "success", message: `${integration} connected successfully!` });
                updateIntegrationStatus(integration, true);
            } else {
                setNotification({ type: "error", message: `Failed to connect ${integration}` });
            }
            // Clear URL params
            window.history.replaceState({}, "", "/dashboard/settings");
        }

        if (payment === "success") {
            setPlan("Pro");
            setNotification({ type: "success", message: "Payment successful! Welcome to Pro!" });
            window.history.replaceState({}, "", "/dashboard/settings");
        }
    }, [searchParams]);

    const [isUpgrading, setIsUpgrading] = useState(false);

    const handleUpgrade = async () => {
        if (!session?.user?.email) return;
        setIsUpgrading(true);

        try {
            console.log("Initiating payment for:", session.user.email);
            // Hardcode URL to match other fixes
            const res = await fetch(`http://localhost:8001/api/payment/upgrade`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: session.user.email })
            });

            const data = await res.json();
            if (data.payment_url) {
                window.location.href = data.payment_url;
            } else {
                setIsUpgrading(false);
            }
        } catch (error) {
            console.error("Payment error:", error);
            setIsUpgrading(false);
            // Fallback for demo
            window.location.href = "/dashboard/settings?payment=success";
        }
    };

    // ...

    {
        plan === 'Free' && (
            <button
                onClick={handleUpgrade}
                disabled={isUpgrading}
                className={`px-3 py-1 bg-gradient-to-r from-blue-600 to-violet-600 text-white text-xs font-bold rounded shadow-lg shadow-blue-500/20 transition-transform ${isUpgrading ? "opacity-75 cursor-wait" : "hover:scale-105"}`}
            >
                {isUpgrading ? "Processing..." : "Upgrade to Pro"}
            </button>
        )
    }
    const handleConnect = (service: string) => {
        if (service === "reddit") {
            signIn("reddit", { callbackUrl: "/dashboard/settings?integration=reddit&status=success" });
        } else if (service === "tiktok") {
            window.location.href = "/api/integrations/tiktok/auth";
        } else if (service === "twitter") {
            signIn("twitter", { callbackUrl: "/dashboard/settings?integration=twitter&status=success" });
        } else if (service === "instagram" || service === "facebook") {
            alert(`${service} integration requires Meta Business API setup. Coming soon!`);
        } else if (service === "jira") {
            if (plan === "Pro") {
                alert("Jira integration coming soon!");
            }
        }
    };

    return (
        <div className="flex h-screen bg-background text-foreground overflow-hidden">
            <Sidebar />
            <main className="flex-1 overflow-y-auto p-8 pt-12">
                <div className="max-w-2xl mx-auto">
                    <h1 className="text-3xl font-bold mb-8">Settings</h1>

                    {/* Notification Banner */}
                    {notification && (
                        <div className={`mb-6 p-4 rounded-lg ${notification.type === "success" ? "bg-green-500/20 border border-green-500/50 text-green-400" : "bg-red-500/20 border border-red-500/50 text-red-400"}`}>
                            {notification.message}
                            <button onClick={() => setNotification(null)} className="float-right">‚úï</button>
                        </div>
                    )}

                    <div className="space-y-6">
                        {/* Profile Section */}
                        <div className="glass-card p-6 border-primary/10">
                            <h2 className="text-xl font-bold mb-4 flex justify-between items-center">
                                Profile
                                <div className="flex items-center gap-2">
                                    <span className={`text-xs px-2 py-1 rounded border ${plan === 'Pro' ? 'bg-blue-500/20 text-blue-400 border-blue-500/50' : 'bg-secondary text-muted'}`}>
                                        {plan.toUpperCase()} PLAN
                                    </span>
                                    {plan === 'Free' && (
                                        <button
                                            onClick={handleUpgrade}
                                            disabled={isUpgrading}
                                            className={`px-3 py-1 bg-gradient-to-r from-blue-600 to-violet-600 text-white text-xs font-bold rounded shadow-lg shadow-blue-500/20 transition-transform ${isUpgrading ? "opacity-75 cursor-wait" : "hover:scale-105"}`}
                                        >
                                            {isUpgrading ? "Processing..." : "Upgrade to Pro"}
                                        </button>
                                    )}
                                </div>
                            </h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1 text-muted">Full Name</label>
                                    <input
                                        type="text"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        className="w-full bg-secondary/30 border border-border rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-primary"
                                        placeholder="Your Name"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1 text-muted">Email</label>
                                    <input type="email" value={session?.user?.email || ""} disabled className="w-full bg-secondary/30 border border-border rounded-lg px-4 py-2 text-sm opacity-50" />
                                </div>
                                <button
                                    onClick={handleUpdateProfile}
                                    className="px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors">
                                    Update Profile
                                </button>
                            </div>
                        </div>

                        {/* Monitoring Configuration */}
                        <div className="glass-card p-6 border-primary/10">
                            <h2 className="text-xl font-bold mb-4">Monitoring Configuration</h2>
                            <p className="text-sm text-muted mb-4">Tell the agent where to listen for feedback across all platforms.</p>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Global Keywords / Brand Terms</label>
                                    <input
                                        type="text"
                                        name="keywords"
                                        value={config.keywords}
                                        onChange={handleConfigChange}
                                        placeholder="e.g. 'Loop Closer', 'Customer Service AI'"
                                        className="w-full bg-secondary/30 border border-border rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-primary"
                                    />
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Reddit Subreddits</label>
                                        <input
                                            type="text"
                                            name="subreddits"
                                            value={config.subreddits}
                                            onChange={handleConfigChange}
                                            placeholder="e.g. r/saas, r/tech"
                                            className="w-full bg-secondary/30 border border-border rounded-lg px-4 py-2 text-sm"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Twitter Search Terms</label>
                                        <input
                                            type="text"
                                            name="twitter_keywords"
                                            value={config.twitter_keywords}
                                            onChange={handleConfigChange}
                                            placeholder="e.g. 'competitor name', 'industry news'"
                                            className="w-full bg-secondary/30 border border-border rounded-lg px-4 py-2 text-sm"
                                        />
                                    </div>
                                </div>
                                <div className="pt-2">
                                    <button
                                        onClick={handleSaveConfig}
                                        disabled={isSavingConfig}
                                        className={`px-4 py-2 bg-secondary border border-border text-foreground transition-colors rounded-lg text-sm flex items-center gap-2 ${isSavingConfig ? "opacity-75 cursor-wait" : "hover:bg-card"}`}
                                    >
                                        {isSavingConfig ? (
                                            <>
                                                <span className="w-3 h-3 border-2 border-foreground/30 border-t-foreground rounded-full animate-spin" />
                                                Saving...
                                            </>
                                        ) : "Save Configuration"}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Integration Section */}
                        <div className="glass-card p-6 border-primary/10">
                            <h2 className="text-xl font-bold mb-4">Integrations</h2>
                            <div className="space-y-4">
                                {/* Reddit */}
                                <div className="flex items-center justify-between p-4 bg-secondary/20 rounded-lg">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded bg-[#FF4500] flex items-center justify-center font-bold text-white text-xs">R</div>
                                        <div>
                                            <p className="font-medium">Reddit</p>
                                            <p className={`text-xs ${integrations.reddit ? "text-green-400" : "text-muted"}`}>
                                                {integrations.reddit ? "Connected" : "Not Connected"}
                                            </p>
                                        </div>
                                    </div>
                                    {integrations.reddit ? (
                                        <button className="text-xs text-muted hover:text-foreground">Configure</button>
                                    ) : (
                                        <button onClick={() => handleConnect("reddit")} className="px-3 py-1 bg-secondary hover:bg-border border border-border rounded text-xs">Connect</button>
                                    )}
                                </div>

                                {/* TikTok */}
                                <div className="flex items-center justify-between p-4 bg-secondary/20 rounded-lg opacity-75">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded bg-black flex items-center justify-center font-bold text-white text-xs">T</div>
                                        <div>
                                            <p className="font-medium">TikTok</p>
                                            <p className="text-xs text-muted">Coming Soon</p>
                                        </div>
                                    </div>
                                    <button disabled className="px-3 py-1 bg-secondary/50 border border-border/50 text-muted rounded text-xs cursor-not-allowed">Coming Soon</button>
                                </div>

                                {/* X (Twitter) */}
                                <div className="flex items-center justify-between p-4 bg-secondary/20 rounded-lg">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded bg-black flex items-center justify-center font-bold text-white text-xs">ùïè</div>
                                        <div>
                                            <p className="font-medium">X (Twitter)</p>
                                            <p className={`text-xs ${integrations.twitter ? "text-green-400" : "text-muted"}`}>
                                                {integrations.twitter ? "Connected" : "Not Connected"}
                                            </p>
                                        </div>
                                    </div>
                                    {integrations.twitter ? (
                                        <button className="text-xs text-muted hover:text-foreground">Configure</button>
                                    ) : (
                                        <button onClick={() => handleConnect("twitter")} className="px-3 py-1 bg-secondary hover:bg-border border border-border rounded text-xs">Connect</button>
                                    )}
                                </div>

                                {/* Instagram */}
                                <div className="flex items-center justify-between p-4 bg-secondary/20 rounded-lg opacity-75">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 flex items-center justify-center font-bold text-white text-xs">I</div>
                                        <div>
                                            <p className="font-medium">Instagram</p>
                                            <p className="text-xs text-muted">Coming Soon</p>
                                        </div>
                                    </div>
                                    <button disabled className="px-3 py-1 bg-secondary/50 border border-border/50 text-muted rounded text-xs cursor-not-allowed">Coming Soon</button>
                                </div>

                                {/* Facebook */}
                                <div className="flex items-center justify-between p-4 bg-secondary/20 rounded-lg opacity-75">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded bg-blue-600 flex items-center justify-center font-bold text-white text-xs">F</div>
                                        <div>
                                            <p className="font-medium">Facebook</p>
                                            <p className="text-xs text-muted">Coming Soon</p>
                                        </div>
                                    </div>
                                    <button disabled className="px-3 py-1 bg-secondary/50 border border-border/50 text-muted rounded text-xs cursor-not-allowed">Coming Soon</button>
                                </div>

                                {/* Jira (Up sell) */}
                                <div className="flex items-center justify-between p-4 bg-secondary/20 rounded-lg opacity-75">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded bg-blue-500 flex items-center justify-center font-bold text-white text-xs">J</div>
                                        <div>
                                            <p className="font-medium">Jira</p>
                                            <p className="text-xs text-muted">Coming Soon</p>
                                        </div>
                                    </div>
                                    <button disabled className="px-3 py-1 bg-secondary/50 border border-border/50 text-muted rounded text-xs cursor-not-allowed">Coming Soon</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    );
}

export default function SettingsPage() {
    return (
        <Suspense fallback={
            <div className="flex h-screen bg-background text-foreground items-center justify-center">
                <div className="animate-pulse">Loading settings...</div>
            </div>
        }>
            <SettingsContent />
        </Suspense>
    );
}
